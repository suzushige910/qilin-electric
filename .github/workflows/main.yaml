name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER:   ${{ secrets.USERNAME }}
      SSH_HOST:   ${{ secrets.HOST }}
      SSH_PORT:   10022
      REMOTE_DIR: /home/suzushige/qilin-electric.com/public_html/wp-content/themes/qilin-electric

    steps:
      # --- 1. ã‚½ãƒ¼ã‚¹å–å¾— ---
      - uses: actions/checkout@v4

      # --- 2. ç§˜å¯†éµã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Setup SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh

          echo "ğŸ”‘ Writing private key..."
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_deploy

          # LFã«çµ±ä¸€
          tr -d '\r' < ~/.ssh/id_deploy > ~/.ssh/id_clean
          mv ~/.ssh/id_clean ~/.ssh/id_deploy

          chmod 600 ~/.ssh/id_deploy

          echo "ğŸ” Starting ssh-agent"
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_deploy

          echo "ğŸ“„ Creating SSH config"
          cat > ~/.ssh/config <<EOF
          Host deploy-server
            HostName $SSH_HOST
            Port $SSH_PORT
            User $SSH_USER
            IdentityFile ~/.ssh/id_deploy
            IdentitiesOnly yes
            StrictHostKeyChecking no
          EOF

          chmod 600 ~/.ssh/config

      # --- 3. known_hosts ç™»éŒ² ---
      - name: Add Server host key
        run: |
          echo "ğŸ” Fetching host key..."
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      # --- 4. SSH ã‚­ãƒ¼ã®æŒ‡ç´‹ç¢ºèª ---
      - name: Show private key fingerprint
        run: |
          echo "===== Local private key fingerprint ====="
          ssh-keygen -lf ~/.ssh/id_deploy || echo "no key found"
          echo "========================================"

      # --- 5. SSH è¨­å®šå†…å®¹ã®è¡¨ç¤º ---
      - name: Show SSH config
        run: |
          echo "===== ~/.ssh/config ====="
          cat ~/.ssh/config
          echo "=========================="

      # --- 6. SSH æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆè¶…è©³ç´°ãƒ­ã‚°ï¼‰ ---
      - name: Test SSH connection (verbose)
        run: |
          echo "===== SSH -vvv TEST START ====="
          ssh -vvv deploy-server "echo 'SSH OK on $(hostname) at $(date)'"
          echo "===== SSH -vvv TEST END ====="

      # --- 7. â˜… æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ â˜… ---
      - name: Deploy on remote host
        run: |
          set -euo pipefail
          ssh deploy-server << 'EOF'
            set -e
            DEPLOY_DIR="/home/suzushige/qilin-electric.com/public_html/wp-content/themes/qilin-electric"

            echo "ğŸ“ Checking directory..."
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating $DEPLOY_DIR"
              mkdir -p "$DEPLOY_DIR"
            fi

            echo "ğŸ“‚ Moving into directory"
            cd "$DEPLOY_DIR"

            if [ ! -d ".git" ]; then
              echo "ğŸŒ± Initial clone"
              cd ..
              rm -rf qilin-electric
              git clone https://github.com/suzushige910/qilin-electric.git qilin-electric
              cd qilin-electric
            else
              echo "ğŸ”„ Updating repository"
              git fetch origin
              git reset --hard origin/main
            fi

            echo "ğŸ‰ Deployment completed at $(date)"
          EOF